From 53bc270cc2ec6f6daf3921faf394b808e243e1b6 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 18 May 2016 08:11:53 -0400
Subject: [PATCH] Fix allocation of memory for CVE-2016-5688

(cherry picked from commit f7c2e897c0f990d663026055a2b40e1be7e16ede)

This is a partial fix for CVE-2016-5688

This also fix test suite

origin: upstream, https://github.com/ImageMagick/ImageMagick/commit/f7c2e897c0f990d663026055a2b40e1be7e16ede
bug-debian: https://bugs.debian.org/833003
bug: https://github.com/ImageMagick/ImageMagick/issues/202
---
 magick/cache.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

Index: imagemagick-6.6.9.7/magick/cache.c
===================================================================
--- imagemagick-6.6.9.7.orig/magick/cache.c	2016-11-15 15:44:36.698147551 -0500
+++ imagemagick-6.6.9.7/magick/cache.c	2016-11-15 15:44:36.694147502 -0500
@@ -4191,9 +4191,13 @@
       status=AcquireMagickResource(MapResource,cache_info->length);
       if ((status == MagickFalse) && (cache_info->type != MapCache) &&
           (cache_info->type != MemoryCache))
-        cache_info->type=DiskCache;
+        {
+          status=MagickTrue;
+          cache_info->type=DiskCache;
+        }
       else
         {
+          status=MagickTrue;
           cache_info->pixels=(PixelPacket *) MapBlob(cache_info->file,mode,
             cache_info->offset,(size_t) cache_info->length);
           if (cache_info->pixels == (PixelPacket *) NULL)
