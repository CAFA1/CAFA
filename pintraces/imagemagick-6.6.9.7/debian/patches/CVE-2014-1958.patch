Description: fix denial of service and possible code execution via psd
 images processing rle decoding buffer overflow
Origin: upstream, http://trac.imagemagick.org/changeset/14801
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=1067276
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=740250

Index: imagemagick-6.6.9.7/coders/psd.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/psd.c	2014-03-06 11:34:11.437403537 -0500
+++ imagemagick-6.6.9.7/coders/psd.c	2014-03-06 11:34:11.433403537 -0500
@@ -266,13 +266,15 @@
   packets=(ssize_t) number_compact_pixels;
   for (i=0; (packets > 1) && (i < (ssize_t) number_pixels); )
   {
-    length=(*compact_pixels++);
+    length=(size_t) (*compact_pixels++);
     packets--;
     if (length == 128)
       continue;
     if (length > 128)
       {
         length=256-length+1;
+        if ((ssize_t) length + i > (ssize_t) number_pixels)
+          length=number_pixels-(size_t) i;
         pixel=(*compact_pixels++);
         packets--;
         for (j=0; j < (ssize_t) length; j++)
@@ -319,6 +321,8 @@
         continue;
       }
     length++;
+    if ((ssize_t) length + i > (ssize_t) number_pixels)
+      length=number_pixels-(size_t) i;
     for (j=0; j < (ssize_t) length; j++)
     {
       switch (depth)
