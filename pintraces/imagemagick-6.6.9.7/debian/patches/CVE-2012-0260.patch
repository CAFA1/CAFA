Description: fix denial of service via crafted sequence of restart markers
Origin: backport, http://trac.imagemagick.org/changeset/7249
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=807994

Index: imagemagick-6.6.9.7/coders/jpeg.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/jpeg.c	2011-04-30 15:15:00.000000000 -0400
+++ imagemagick-6.6.9.7/coders/jpeg.c	2014-03-06 11:33:26.069401842 -0500
@@ -145,6 +145,9 @@
 static MagickBooleanType
   WriteJPEGImage(const ImageInfo *,Image *);
 #endif
+static void 
+  JPEGErrorHandler(j_common_ptr);
+
 
 /*
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
@@ -211,6 +214,8 @@
 
 static MagickBooleanType EmitMessage(j_common_ptr jpeg_info,int level)
 {
+#define JPEGExcessiveWarnings  1000
+
   char
     message[JMSG_LENGTH_MAX];
 
@@ -225,11 +230,12 @@
   image=error_manager->image;
   if (level < 0)
     {
+      if (jpeg_info->err->num_warnings++ > JPEGExcessiveWarnings)
+        JPEGErrorHandler(jpeg_info);
       if ((jpeg_info->err->num_warnings == 0) ||
           (jpeg_info->err->trace_level >= 3))
         ThrowBinaryException(CorruptImageWarning,(char *) message,
           image->filename);
-      jpeg_info->err->num_warnings++;
     }
   else
     if (jpeg_info->err->trace_level >= level)
