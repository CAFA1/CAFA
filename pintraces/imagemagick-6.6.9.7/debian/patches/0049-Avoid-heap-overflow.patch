Backport of:

From ac74497be613d3fb246ce3a17457d08ac81d12fe Mon Sep 17 00:00:00 2001
From: cristy <cristy@aa41f4f7-0bf4-0310-aa73-e5a19afd5a74>
Date: Sun, 14 Dec 2014 17:43:28 +0000
Subject: [PATCH] Avoid heap overflow

Avoid to allocate too much memory

git-svn-id: https://subversion.imagemagick.org/subversion/ImageMagick/branches/ImageMagick-6@17210 aa41f4f7-0bf4-0310-aa73-e5a19afd5a74
origin:  http://trac.imagemagick.org/changeset/17210
---
 coders/fits.c    |  2 +-
 coders/pnm.c     | 14 ++++++++++----
 magick/quantum.c |  4 ++--
 3 files changed, 13 insertions(+), 7 deletions(-)

Index: imagemagick-6.6.9.7/coders/fits.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/fits.c	2016-11-15 13:32:22.085263497 -0500
+++ imagemagick-6.6.9.7/coders/fits.c	2016-11-15 13:32:22.081263448 -0500
@@ -645,7 +645,7 @@
     Initialize image header.
   */
   image->depth=GetImageQuantumDepth(image,MagickFalse);
-  quantum_info=AcquireQuantumInfo((const ImageInfo *) NULL,image);
+  quantum_info=AcquireQuantumInfo(image_info,image);
   if (quantum_info == (QuantumInfo *) NULL)
     ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
   offset=0;
Index: imagemagick-6.6.9.7/coders/pnm.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pnm.c	2016-11-15 13:32:22.085263497 -0500
+++ imagemagick-6.6.9.7/coders/pnm.c	2016-11-15 13:32:22.081263448 -0500
@@ -1802,7 +1802,7 @@
           Convert image to a PBM image.
         */
         image->depth=1;
-        quantum_info=AcquireQuantumInfo((const ImageInfo *) NULL,image);
+        quantum_info=AcquireQuantumInfo(image_info,image);
         if (quantum_info == (QuantumInfo *) NULL)
           ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
         quantum_info->min_is_white=MagickTrue;
@@ -1844,7 +1844,7 @@
         (void) FormatMagickString(buffer,MaxTextExtent,"%.20g\n",(double)
           GetQuantumRange(image->depth));
         (void) WriteBlobString(image,buffer);
-        quantum_info=AcquireQuantumInfo((const ImageInfo *) NULL,image);
+        quantum_info=AcquireQuantumInfo(image_info,image);
         if (quantum_info == (QuantumInfo *) NULL)
           ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
         quantum_info->min_is_white=MagickTrue;
@@ -1927,7 +1927,7 @@
         (void) FormatMagickString(buffer,MaxTextExtent,"%.20g\n",(double)
           GetQuantumRange(image->depth));
         (void) WriteBlobString(image,buffer);
-        quantum_info=AcquireQuantumInfo((const ImageInfo *) NULL,image);
+        quantum_info=AcquireQuantumInfo(image_info,image);
         if (quantum_info == (QuantumInfo *) NULL)
           ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
         pixels=GetQuantumPixels(quantum_info);
@@ -1998,7 +1998,9 @@
         */
         if (image->depth > 16)
           image->depth=16;
-        quantum_info=AcquireQuantumInfo((const ImageInfo *) NULL,image);
+        quantum_info=AcquireQuantumInfo(image_info,image);
+        if (quantum_info == (QuantumInfo *) NULL)
+          ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
         pixels=GetQuantumPixels(quantum_info);
         range=GetQuantumRange(image->depth);
         for (y=0; y < (ssize_t) image->rows; y++)
