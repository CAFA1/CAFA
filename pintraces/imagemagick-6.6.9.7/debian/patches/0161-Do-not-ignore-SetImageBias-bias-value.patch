Backport of:

From 45b2d5aefde5f5ccd4f1bd6f810becfe7af7f9aa Mon Sep 17 00:00:00 2001
From: cristy <urban-warrior@git.imagemagick.org>
Date: Sun, 14 Dec 2014 23:36:27 +0000
Subject: [PATCH] Do not ignore SetImageBias() bias value

This patch is needed in order to bail out early in case of exception, and thus avoiding a DOS

origin: upstream, https://github.com/ImageMagick/ImageMagick/commit/f6e9d0d9955e85bdd7540b251cd50d598dacc5e6

Last-Update: 2017-02-22

---
 coders/aai.c        |  6 ++++++
 coders/art.c        |  6 ++++++
 coders/avs.c        |  6 ++++++
 coders/bgr.c        |  6 ++++++
 coders/bmp.c        |  6 ++++++
 coders/cin.c        |  8 +++++++-
 coders/clipboard.c  | 10 ++++++++--
 coders/cmyk.c       |  6 ++++++
 coders/cut.c        |  8 +++++++-
 coders/dcm.c        |  6 ++++++
 coders/dds.c        |  6 ++++++
 coders/dib.c        |  8 +++++++-
 coders/djvu.c       |  9 ++++++++-
 coders/dps.c        |  6 ++++++
 coders/dpx.c        |  6 ++++++
 coders/emf.c        |  6 ++++++
 coders/exr.c        |  6 ++++++
 coders/fax.c        |  6 ++++++
 coders/fits.c       |  6 ++++++
 coders/fpx.c        |  6 ++++++
 coders/gif.c        |  6 ++++++
 coders/gray.c       |  6 ++++++
 coders/hald.c       |  9 +++++++--
 coders/hdr.c        |  6 ++++++
 coders/hrz.c        |  6 ++++++
 coders/icon.c       |  6 ++++++
 coders/ipl.c        |  8 +++++++-
 coders/jbig.c       |  6 ++++++
 coders/jp2.c        |  6 ++++++
 coders/jpeg.c       |  6 ++++++
 coders/label.c      |  6 ++++++
 coders/mac.c        |  6 ++++++
 coders/map.c        |  6 ++++++
 coders/mat.c        |  6 ++++++
 coders/miff.c       |  6 ++++++
 coders/mono.c       |  6 ++++++
 coders/mpc.c        |  6 ++++++
 coders/mtv.c        |  6 ++++++
 coders/mvg.c        |  6 ++++++
 coders/null.c       |  9 +++++++++
 coders/otb.c        |  6 ++++++
 coders/palm.c       |  6 ++++++
 coders/pango.c      | 10 ++++++++--
 coders/pcd.c        |  6 ++++++
 coders/pcx.c        |  6 ++++++
 coders/pdb.c        |  6 ++++++
 coders/pict.c       |  6 ++++++
 coders/pix.c        |  6 ++++++
 coders/psd.c        |  6 ++++++
 coders/raw.c        |  6 ++++++
 coders/rgb.c        |  6 ++++++
 coders/rgf.c        |  8 ++++++--
 coders/rla.c        |  6 ++++++
 coders/rle.c        |  6 ++++++
 coders/scr.c        |  6 ++++++
 coders/screenshot.c | 10 +++++++++-
 coders/sct.c        |  6 ++++++
 coders/sgi.c        |  6 ++++++
 coders/sixel.c      |  7 ++++++-
 coders/stegano.c    |  6 ++++++
 coders/sun.c        |  6 ++++++
 coders/svg.c        |  6 ++++++
 coders/tga.c        |  6 ++++++
 coders/tiff.c       |  6 ++++++
 coders/tile.c       |  9 +++++++++
 coders/tim.c        |  6 ++++++
 coders/ttf.c        |  6 ++++++
 coders/txt.c        | 12 ++++++++++++
 coders/uyvy.c       |  6 ++++++
 coders/vicar.c      |  6 ++++++
 coders/viff.c       |  6 ++++++
 coders/vips.c       |  6 ++++++
 coders/wbmp.c       |  6 ++++++
 coders/webp.c       |  6 ++++++
 coders/wmf.c        |  9 +++++++++
 coders/wpg.c        |  6 ++++++
 coders/xbm.c        |  6 ++++++
 coders/xc.c         |  6 ++++++
 coders/xcf.c        |  6 ++++++
 coders/xpm.c        |  6 ++++++
 coders/xwd.c        |  6 ++++++
 coders/ycbcr.c      | 12 ++++++++++++
 coders/yuv.c        | 12 ++++++++++++
 83 files changed, 539 insertions(+), 15 deletions(-)

Index: imagemagick-6.6.9.7/coders/aai.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/aai.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/aai.c	2017-02-22 10:10:18.569520721 -0500
@@ -156,6 +156,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     pixels=(unsigned char *) AcquireQuantumMemory(image->columns,
       4*sizeof(*pixels));
     if (pixels == (unsigned char *) NULL) 
Index: imagemagick-6.6.9.7/coders/art.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/art.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/art.c	2017-02-22 10:10:18.573520765 -0500
@@ -150,6 +150,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert bi-level image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/avs.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/avs.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/avs.c	2017-02-22 10:10:18.577520808 -0500
@@ -156,6 +156,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     pixels=(unsigned char *) AcquireQuantumMemory(image->columns,
       4*sizeof(*pixels));
     if (pixels == (unsigned char *) NULL) 
Index: imagemagick-6.6.9.7/coders/bgr.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/bgr.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/bgr.c	2017-02-22 10:10:18.585520897 -0500
@@ -196,6 +196,12 @@
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
     image->colorspace=RGBColorspace;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     switch (image_info->interlace)
     {
       case NoInterlace:
Index: imagemagick-6.6.9.7/coders/bmp.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/bmp.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/bmp.c	2017-02-22 10:10:18.589520940 -0500
@@ -886,6 +886,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Read image data.
     */
Index: imagemagick-6.6.9.7/coders/cin.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/cin.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/cin.c	2017-02-22 10:10:18.593520984 -0500
@@ -687,11 +687,17 @@
   image->depth=cin.image.channel[0].bits_per_pixel;
   image->columns=cin.image.channel[0].pixels_per_line;
   image->rows=cin.image.channel[0].lines_per_image;
-  if (image_info->ping)
+  if (image_info->ping != MagickFalse)
     {
       (void) CloseBlob(image);
       return(image);
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert CIN raster image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/clipboard.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/clipboard.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/clipboard.c	2017-02-22 10:10:18.597521028 -0500
@@ -134,7 +134,7 @@
     bitmapH=(HBITMAP) GetClipboardData(CF_BITMAP);
     hPal=(HPALETTE) GetClipboardData(CF_PALETTE);
     CloseClipboard();
-    if ( bitmapH == NULL )
+    if (bitmapH == NULL)
       ThrowReaderException(CoderError,"NoBitmapOnClipboard");
     {
       BITMAPINFO
@@ -161,8 +161,14 @@
       GetObject(bitmapH,sizeof(BITMAP),(LPSTR) &bitmap);
       if ((image->columns == 0) || (image->rows == 0))
         {
-          image->rows=bitmap.bmHeight;
           image->columns=bitmap.bmWidth;
+          image->rows=bitmap.bmHeight;
+        }
+      status=SetImageExtent(image,image->columns,image->rows);
+      if (status == MagickFalse)
+        {
+          InheritException(exception,&image->exception);
+          return(DestroyImageList(image));
         }
       /*
         Initialize the bitmap header info.
Index: imagemagick-6.6.9.7/coders/cmyk.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/cmyk.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/cmyk.c	2017-02-22 10:10:18.601521071 -0500
@@ -195,6 +195,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     image->colorspace=CMYKColorspace;
     switch (image_info->interlace)
     {
Index: imagemagick-6.6.9.7/coders/cut.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/cut.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/cut.c	2017-02-22 10:10:18.605521116 -0500
@@ -366,7 +366,13 @@
   image->depth=8;
   image->colors=(size_t) (GetQuantumRange(1UL*i)+1);
 
-  if (image_info->ping) goto Finish;
+  if (image_info->ping != MagickFalse) goto Finish;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
 
   /* ----- Do something with palette ----- */
   if ((clone_info=CloneImageInfo(image_info)) == NULL) goto NoPalette;
Index: imagemagick-6.6.9.7/coders/dcm.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/dcm.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/dcm.c	2017-02-22 10:10:18.613521204 -0500
@@ -3651,6 +3651,12 @@
     image->columns=(size_t) width;
     image->rows=(size_t) height;
     image->depth=depth;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        break;
+      }
     if ((image->colormap == (PixelPacket *) NULL) && (samples_per_pixel == 1))
       {
         size_t
Index: imagemagick-6.6.9.7/coders/dds.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/dds.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/dds.c	2017-02-22 10:10:18.617521248 -0500
@@ -388,7 +388,13 @@
         (void) CloseBlob(image);
         return(GetFirstImageInList(image));
       }
-    
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
+
     if ((decoder)(image, &dds_info) != MagickTrue)
       {
         (void) CloseBlob(image);
Index: imagemagick-6.6.9.7/coders/dib.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/dib.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/dib.c	2017-02-22 10:10:18.621521292 -0500
@@ -518,7 +518,7 @@
   */
   (void) ResetMagickMemory(&dib_info,0,sizeof(dib_info));
   dib_info.size=ReadBlobLSBLong(image);
-  if (dib_info.size!=40)
+  if (dib_info.size != 40)
     ThrowReaderException(CorruptImageError,"ImproperImageHeader");
   /*
     Microsoft Windows 3.X DIB image file.
@@ -604,6 +604,12 @@
         if ((geometry.height != 0) && (geometry.height < image->rows))
           image->rows=geometry.height;
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (image->storage_class == PseudoClass)
     {
       size_t
Index: imagemagick-6.6.9.7/coders/djvu.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/djvu.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/djvu.c	2017-02-22 10:10:18.625521335 -0500
@@ -416,7 +416,7 @@
                                 if (SyncAuthenticPixels(image,&image->exception) == MagickFalse)
                                         break;
                         }
-                if (!image->ping)
+                if (image->ping == MagickFalse)
                   SyncImage(image);
         } else {
 #if DEBUG
@@ -573,6 +573,7 @@
   Image *image;
   int logging;
   int tag;
+  MagickBooleanType status;
 
         /* so, we know that the page is there! Get its dimension, and  */
 
@@ -663,6 +664,12 @@
                 image->matte = MagickTrue;
                 /* is this useful? */
         }
+        status=SetImageExtent(image,image->columns,image->rows);
+        if (status == MagickFalse)
+          {
+            InheritException(exception,&image->exception);
+            return(DestroyImageList(image));
+          }
 #if DEBUG
         printf("now filling %.20g x %.20g\n",(double) image->columns,(double)
           image->rows);
Index: imagemagick-6.6.9.7/coders/dps.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/dps.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/dps.c	2017-02-22 10:10:18.633521424 -0500
@@ -327,6 +327,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   switch (image->storage_class)
   {
     case DirectClass:
Index: imagemagick-6.6.9.7/coders/dpx.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/dpx.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/dpx.c	2017-02-22 10:10:18.637521467 -0500
@@ -1007,6 +1007,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert DPX raster image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/emf.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/emf.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/emf.c	2017-02-22 10:10:18.641521511 -0500
@@ -503,6 +503,12 @@
       y=0;
       (void) GetGeometry(image_info->size,&x,&y,&image->columns,&image->rows);
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (image_info->page != (char *) NULL)
     {
       char
Index: imagemagick-6.6.9.7/coders/exr.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/exr.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/exr.c	2017-02-22 10:10:18.645521554 -0500
@@ -210,6 +210,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   scanline=(ImfRgba *) AcquireQuantumMemory(image->columns,sizeof(*scanline));
   if (scanline == (ImfRgba *) NULL)
     {
Index: imagemagick-6.6.9.7/coders/fax.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/fax.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/fax.c	2017-02-22 10:10:18.665521774 -0500
@@ -176,6 +176,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   status=HuffmanDecodeImage(image);
   if (status == MagickFalse)
     ThrowReaderException(CorruptImageError,"UnableToReadImageData");
Index: imagemagick-6.6.9.7/coders/fits.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/fits.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/fits.c	2017-02-22 10:10:18.669521819 -0500
@@ -418,6 +418,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Initialize image structure.
     */
Index: imagemagick-6.6.9.7/coders/fpx.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/fpx.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/fpx.c	2017-02-22 10:10:18.677521907 -0500
@@ -382,6 +382,12 @@
       FPX_ClearSystem();
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Allocate memory for the image and pixel buffer.
   */
Index: imagemagick-6.6.9.7/coders/gif.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/gif.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/gif.c	2017-02-22 10:10:18.681521950 -0500
@@ -1319,6 +1319,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Decode image.
     */
Index: imagemagick-6.6.9.7/coders/gray.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/gray.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/gray.c	2017-02-22 10:10:18.685521994 -0500
@@ -183,6 +183,13 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
+    SetImageColorspace(image,GRAYColorspace);
     if (scene == 0)
       {
         length=GetQuantumExtent(canvas_image,quantum_info,quantum_type);
Index: imagemagick-6.6.9.7/coders/hald.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/hald.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/hald.c	2017-02-22 10:10:18.689522039 -0500
@@ -122,6 +122,12 @@
   cube_size=level*level;
   image->columns=(size_t) (level*cube_size);
   image->rows=(size_t) (level*cube_size);
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   for (y=0; y < (ssize_t) image->rows; y+=(ssize_t) level)
   {
     ssize_t
@@ -134,8 +140,7 @@
 
     if (status == MagickFalse)
       continue;
-    q=QueueAuthenticPixels(image,0,y,image->columns,(size_t) level,
-      exception);
+    q=QueueAuthenticPixels(image,0,y,image->columns,(size_t) level,exception);
     if (q == (PixelPacket *) NULL)
       {
         status=MagickFalse;
Index: imagemagick-6.6.9.7/coders/hdr.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/hdr.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/hdr.c	2017-02-22 10:10:18.697522126 -0500
@@ -383,6 +383,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Read RGBE (red+green+blue+exponent) pixels.
   */
Index: imagemagick-6.6.9.7/coders/hrz.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/hrz.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/hrz.c	2017-02-22 10:10:18.717522346 -0500
@@ -140,6 +140,12 @@
   image->columns=256;
   image->rows=240;
   image->depth=8;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   pixels=(unsigned char *) AcquireQuantumMemory(image->columns,3*
     sizeof(*pixels));
   if (pixels == (unsigned char *) NULL) 
Index: imagemagick-6.6.9.7/coders/icon.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/icon.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/icon.c	2017-02-22 10:10:18.721522390 -0500
@@ -387,6 +387,12 @@
             (image_info->number_scenes != 0))
           if (image->scene >= (image_info->scene+image_info->number_scenes-1))
             break;
+        status=SetImageExtent(image,image->columns,image->rows);
+        if (status == MagickFalse)
+          {
+            InheritException(exception,&image->exception);
+            return(DestroyImageList(image));
+          }
         bytes_per_line=(((image->columns*icon_info.bits_per_pixel)+31) &
           ~31) >> 3;
         (void) bytes_per_line;
Index: imagemagick-6.6.9.7/coders/ipl.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/ipl.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/ipl.c	2017-02-22 10:10:18.737522566 -0500
@@ -311,9 +311,15 @@
   {
     SetHeaderFromIPL(image, &ipl_info);
 
-  if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
+    if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
 /*
    printf("Length: %.20g, Memory size: %.20g\n", (double) length,(double)
      image->depth);
Index: imagemagick-6.6.9.7/coders/jbig.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/jbig.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/jbig.c	2017-02-22 10:10:18.753522741 -0500
@@ -216,6 +216,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert X bitmap image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/jp2.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/jp2.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/jp2.c	2017-02-22 10:10:18.769522916 -0500
@@ -464,6 +464,12 @@
   }
   image->columns=jas_image_width(jp2_image);
   image->rows=jas_image_height(jp2_image);
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   image->compression=JPEG2000Compression;
   for (i=0; i < (ssize_t) number_components; i++)
   {
Index: imagemagick-6.6.9.7/coders/jpeg.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/jpeg.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/jpeg.c	2017-02-22 10:10:18.785523092 -0500
@@ -1145,6 +1145,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   jpeg_pixels=(JSAMPLE *) AcquireQuantumMemory((size_t) image->columns,
     jpeg_info.output_components*sizeof(JSAMPLE));
   if (jpeg_pixels == (JSAMPLE *) NULL)
Index: imagemagick-6.6.9.7/coders/label.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/label.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/label.c	2017-02-22 10:10:18.789523136 -0500
@@ -184,6 +184,12 @@
   if (image->rows == 0)
     image->rows=(size_t) floor(draw_info->pointsize+draw_info->stroke_width+
       0.5);
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (SetImageBackgroundColor(image) == MagickFalse)
     {
       InheritException(exception,&image->exception);
Index: imagemagick-6.6.9.7/coders/mac.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mac.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mac.c	2017-02-22 10:10:18.801523268 -0500
@@ -155,6 +155,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert MAC raster image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/map.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/map.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/map.c	2017-02-22 10:10:18.801523268 -0500
@@ -204,6 +204,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Read image pixels.
   */
Index: imagemagick-6.6.9.7/coders/mat.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mat.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mat.c	2017-02-22 10:10:18.805523312 -0500
@@ -852,6 +852,12 @@
       {
  NoMemory:ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");}
     }
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
 
     /*
       If ping is true, then only set image size and colors without
Index: imagemagick-6.6.9.7/coders/miff.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/miff.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/miff.c	2017-02-22 10:10:18.809523356 -0500
@@ -1201,6 +1201,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Allocate image pixels.
     */
Index: imagemagick-6.6.9.7/coders/mono.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mono.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mono.c	2017-02-22 10:10:18.813523399 -0500
@@ -151,6 +151,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert bi-level image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/mpc.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mpc.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mpc.c	2017-02-22 10:10:18.829523576 -0500
@@ -895,6 +895,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Attach persistent pixel cache.
     */
Index: imagemagick-6.6.9.7/coders/mtv.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mtv.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mtv.c	2017-02-22 10:10:18.833523619 -0500
@@ -156,6 +156,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Convert MTV raster image to pixel packets.
     */
Index: imagemagick-6.6.9.7/coders/mvg.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/mvg.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/mvg.c	2017-02-22 10:10:18.845523751 -0500
@@ -189,6 +189,12 @@
     DefaultResolution;
   image->columns=(size_t) (draw_info->affine.sx*image->columns);
   image->rows=(size_t) (draw_info->affine.sy*image->rows);
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (SetImageBackgroundColor(image) == MagickFalse)
     {
       InheritException(exception,&image->exception);
Index: imagemagick-6.6.9.7/coders/null.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/null.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/null.c	2017-02-22 10:10:18.849523795 -0500
@@ -99,6 +99,9 @@
   Image
     *image;
 
+  MagickBooleanType
+    status;
+
   MagickPixelPacket
     background;
 
@@ -129,6 +132,12 @@
     image->columns=1;
   if (image->rows == 0)
     image->rows=1;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   image->matte=MagickTrue;
   GetMagickPixelPacket(image,&background);
   background.opacity=(MagickRealType) TransparentOpacity;
Index: imagemagick-6.6.9.7/coders/otb.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/otb.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/otb.c	2017-02-22 10:10:18.853523839 -0500
@@ -165,6 +165,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert bi-level image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/palm.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/palm.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/palm.c	2017-02-22 10:10:18.861523927 -0500
@@ -326,6 +326,12 @@
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
     if ((image->columns == 0) || (image->rows == 0))
       ThrowReaderException(CorruptImageError,"NegativeOrZeroImageSize");
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     bytes_per_row=ReadBlobMSBShort(image);
     flags=ReadBlobMSBShort(image);
     bits_per_pixel=(size_t) ReadBlobByte(image);
Index: imagemagick-6.6.9.7/coders/pcd.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pcd.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/pcd.c	2017-02-22 10:10:18.873524059 -0500
@@ -587,6 +587,12 @@
     image->columns<<=1;
     image->rows<<=1;
   }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Allocate luma and chroma memory.
   */
Index: imagemagick-6.6.9.7/coders/pcx.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pcx.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/pcx.c	2017-02-22 10:10:18.877524102 -0500
@@ -382,6 +382,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Read image data.
     */
Index: imagemagick-6.6.9.7/coders/pdb.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pdb.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/pdb.c	2017-02-22 10:10:18.881524147 -0500
@@ -404,6 +404,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   packets=(bits_per_pixel*image->columns+7)/8;
   pixels=(unsigned char *) AcquireQuantumMemory(packets+257UL,image->rows*
     sizeof(*pixels));
Index: imagemagick-6.6.9.7/coders/pict.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pict.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/pict.c	2017-02-22 10:10:18.885524191 -0500
@@ -901,6 +901,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     if ((version == 1) || ((TellBlob(image) % 2) != 0))
       code=ReadBlobByte(image);
     if (version == 2)
Index: imagemagick-6.6.9.7/coders/pix.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/pix.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/pix.c	2017-02-22 10:10:18.901524366 -0500
@@ -160,6 +160,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Convert PIX raster image to pixel packets.
     */
Index: imagemagick-6.6.9.7/coders/psd.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/psd.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/psd.c	2017-02-22 10:10:18.901524366 -0500
@@ -857,6 +857,12 @@
   image->depth=psd_info.depth;
   image->columns=psd_info.columns;
   image->rows=psd_info.rows;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (SetImageBackgroundColor(image) == MagickFalse)
     {
       InheritException(exception,&image->exception);
Index: imagemagick-6.6.9.7/coders/raw.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/raw.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/raw.c	2017-02-22 10:10:18.905524410 -0500
@@ -181,6 +181,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     if (scene == 0)
       {
         length=GetQuantumExtent(canvas_image,quantum_info,quantum_type);
Index: imagemagick-6.6.9.7/coders/rgb.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/rgb.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/rgb.c	2017-02-22 10:10:18.909524454 -0500
@@ -201,6 +201,12 @@
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
     image->colorspace=RGBColorspace;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     switch (image_info->interlace)
     {
       case NoInterlace:
Index: imagemagick-6.6.9.7/coders/rla.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/rla.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/rla.c	2017-02-22 10:10:18.917524541 -0500
@@ -259,6 +259,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   scanlines=(ssize_t *) AcquireQuantumMemory(image->rows,sizeof(*scanlines));
   if (scanlines == (ssize_t *) NULL)
     ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
Index: imagemagick-6.6.9.7/coders/rle.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/rle.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/rle.c	2017-02-22 10:10:18.921524586 -0500
@@ -305,6 +305,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Allocate RLE pixels.
     */
Index: imagemagick-6.6.9.7/coders/scr.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/scr.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/scr.c	2017-02-22 10:10:18.925524630 -0500
@@ -155,6 +155,12 @@
     }
   image->columns = 256;
   image->rows = 192;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   count=ReadBlob(image,6144,(unsigned char *) zxscr);
   (void) count;
   count=ReadBlob(image,768,(unsigned char *) zxattr);
Index: imagemagick-6.6.9.7/coders/sct.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/sct.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/sct.c	2017-02-22 10:10:18.929524674 -0500
@@ -223,6 +223,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert SCT raster image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/sgi.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/sgi.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/sgi.c	2017-02-22 10:10:18.933524718 -0500
@@ -370,6 +370,12 @@
     if ((image_info->ping != MagickFalse)  && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Allocate SGI pixels.
     */
Index: imagemagick-6.6.9.7/coders/stegano.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/stegano.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/stegano.c	2017-02-22 10:10:18.937524761 -0500
@@ -168,6 +168,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Get hidden watermark from low-order bits of image.
   */
Index: imagemagick-6.6.9.7/coders/sun.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/sun.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/sun.c	2017-02-22 10:10:18.941524805 -0500
@@ -400,6 +400,12 @@
         (void) CloseBlob(image);
         return(GetFirstImageInList(image));
       }
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     if ((sun_info.length*sizeof(*sun_data))/sizeof(*sun_data) !=
         sun_info.length || !sun_info.length)
       ThrowReaderException(ResourceLimitError,"ImproperImageHeader");
Index: imagemagick-6.6.9.7/coders/svg.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/svg.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/svg.c	2017-02-22 10:10:18.949524893 -0500
@@ -2813,6 +2813,12 @@
       image->columns=gdk_pixbuf_get_width(pixel_info);
       image->rows=gdk_pixbuf_get_height(pixel_info);
 #endif
+        status=SetImageExtent(image,image->columns,image->rows);
+        if (status == MagickFalse)
+          {
+            InheritException(exception,&image->exception);
+            return(DestroyImageList(image));
+          }
       image->matte=MagickTrue;
       SetImageProperty(image,"svg:base-uri",
         rsvg_handle_get_base_uri(svg_handle));
Index: imagemagick-6.6.9.7/coders/tga.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/tga.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/tga.c	2017-02-22 10:10:18.953524937 -0500
@@ -281,6 +281,12 @@
       (void) SetImageProperty(image,"comment",comment);
       comment=DestroyString(comment);
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   (void) ResetMagickMemory(&pixel,0,sizeof(pixel));
   pixel.opacity=(Quantum) OpaqueOpacity;
   if (tga_info.colormap_type != 0)
Index: imagemagick-6.6.9.7/coders/tiff.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/tiff.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/tiff.c	2017-02-22 10:10:18.957524981 -0500
@@ -940,6 +940,12 @@
     image->columns=(size_t) width;
     image->rows=(size_t) height;
     image->depth=(size_t) bits_per_sample;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     if (image->debug != MagickFalse)
       (void) LogMagickEvent(CoderEvent,GetMagickModule(),"Image depth: %.20g",
         (double) image->depth);
Index: imagemagick-6.6.9.7/coders/tile.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/tile.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/tile.c	2017-02-22 10:10:18.961525024 -0500
@@ -94,6 +94,9 @@
   ImageInfo
     *read_info;
 
+  MagickBooleanType
+    status;
+
   /*
     Initialize Image structure.
   */
@@ -114,6 +117,12 @@
   image=AcquireImage(image_info);
   if ((image->columns == 0) || (image->rows == 0))
     ThrowReaderException(OptionError,"MustSpecifyImageSize");
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if (*image_info->filename == '\0')
     ThrowReaderException(OptionError,"MustSpecifyAnImageName");
   image->matte=tile_image->matte;
Index: imagemagick-6.6.9.7/coders/tim.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/tim.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/tim.c	2017-02-22 10:10:18.965525069 -0500
@@ -221,6 +221,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Read image data.
     */
Index: imagemagick-6.6.9.7/coders/ttf.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/ttf.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/ttf.c	2017-02-22 10:10:18.969525113 -0500
@@ -226,6 +226,12 @@
       image=DestroyImageList(image);
       return((Image *) NULL);
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Color canvas with background color
   */
Index: imagemagick-6.6.9.7/coders/txt.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/txt.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/txt.c	2017-02-22 10:10:18.973525157 -0500
@@ -227,6 +227,12 @@
     delta.x)+0.5);
   image->rows=(size_t) floor((((double) page.height*image->y_resolution)/
     delta.y)+0.5);
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   image->page.x=0;
   image->page.y=0;
   texture=(Image *) NULL;
@@ -431,6 +437,12 @@
     image->rows=height;
     for (depth=1; (GetQuantumRange(depth)+1) < max_value; depth++) ;
     image->depth=depth;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     LocaleLower(colorspace);
     i=(ssize_t) strlen(colorspace)-1;
     image->matte=MagickFalse;
Index: imagemagick-6.6.9.7/coders/uyvy.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/uyvy.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/uyvy.c	2017-02-22 10:10:18.981525244 -0500
@@ -144,6 +144,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Accumulate UYVY, then unpack into two pixels.
   */
Index: imagemagick-6.6.9.7/coders/vicar.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/vicar.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/vicar.c	2017-02-22 10:10:18.985525289 -0500
@@ -288,6 +288,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Read VICAR pixels.
   */
Index: imagemagick-6.6.9.7/coders/viff.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/viff.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/viff.c	2017-02-22 10:10:19.001525464 -0500
@@ -493,6 +493,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     /*
       Allocate VIFF pixels.
     */
Index: imagemagick-6.6.9.7/coders/wbmp.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/wbmp.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/wbmp.c	2017-02-22 10:10:19.005525508 -0500
@@ -182,6 +182,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Convert bi-level image to pixel packets.
   */
Index: imagemagick-6.6.9.7/coders/webp.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/webp.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/webp.c	2017-02-22 10:10:19.021525684 -0500
@@ -162,6 +162,12 @@
     ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
   image->columns=(size_t) width;
   image->rows=(size_t) height;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   p=pixels;
   for (y=0; y < (ssize_t) image->rows; y++)
   {
Index: imagemagick-6.6.9.7/coders/wpg.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/wpg.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/wpg.c	2017-02-22 10:10:19.037525860 -0500
@@ -1440,6 +1440,12 @@
          ThrowReaderException(CoderError,"DataEncodingSchemeIsNotSupported");
       }
    }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
 
  Finish:
   (void) CloseBlob(image);
Index: imagemagick-6.6.9.7/coders/xbm.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/xbm.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/xbm.c	2017-02-22 10:10:19.041525903 -0500
@@ -291,6 +291,12 @@
       (void) CloseBlob(image);
       return(GetFirstImageInList(image));
     }
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   /*
     Initialize hex values.
   */
Index: imagemagick-6.6.9.7/coders/xc.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/xc.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/xc.c	2017-02-22 10:10:19.045525947 -0500
@@ -130,6 +130,12 @@
     image->columns=1;
   if (image->rows == 0)
     image->rows=1;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   (void) CopyMagickString(image->filename,image_info->filename,MaxTextExtent);
   status=QueryMagickColor((char *) image_info->filename,&color,exception);
   if (status == MagickFalse)
Index: imagemagick-6.6.9.7/coders/xcf.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/xcf.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/xcf.c	2017-02-22 10:10:19.053526035 -0500
@@ -1249,6 +1249,12 @@
       XCFLayerInfo
         *layer_info;
 
+      status=SetImageExtent(image,image->columns,image->rows);
+      if (status == MagickFalse)
+        {
+          InheritException(exception,&image->exception);
+          return(DestroyImageList(image));
+        }
       /* 
         the read pointer
       */
Index: imagemagick-6.6.9.7/coders/xpm.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/xpm.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/xpm.c	2017-02-22 10:10:19.057526079 -0500
@@ -401,6 +401,12 @@
       /*
         Read image pixels.
       */
+      status=SetImageExtent(image,image->columns,image->rows);
+      if (status == MagickFalse)
+        {
+          InheritException(exception,&image->exception);
+          return(DestroyImageList(image));
+        }
       for (y=0; y < (ssize_t) image->rows; y++)
       {
         p=NextXPMLine(p);
Index: imagemagick-6.6.9.7/coders/xwd.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/xwd.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/xwd.c	2017-02-22 10:10:19.061526123 -0500
@@ -397,6 +397,12 @@
   image->columns=(size_t) ximage->width;
   image->rows=(size_t) ximage->height;
   image->depth=8;
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   if ((header.ncolors == 0U) || (ximage->red_mask != 0) ||
       (ximage->green_mask != 0) || (ximage->blue_mask != 0))
     image->storage_class=DirectClass;
Index: imagemagick-6.6.9.7/coders/ycbcr.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/ycbcr.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/ycbcr.c	2017-02-22 10:10:19.065526166 -0500
@@ -147,6 +147,12 @@
   image=AcquireImage(image_info);
   if ((image->columns == 0) || (image->rows == 0))
     ThrowReaderException(OptionError,"MustSpecifyImageSize");
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   image->colorspace=YCbCrColorspace;
   if (image_info->interlace != PartitionInterlace)
     {
@@ -202,6 +208,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     image->colorspace=YCbCrColorspace;
     switch (image_info->interlace)
     {
Index: imagemagick-6.6.9.7/coders/yuv.c
===================================================================
--- imagemagick-6.6.9.7.orig/coders/yuv.c	2017-02-22 10:10:19.077526299 -0500
+++ imagemagick-6.6.9.7/coders/yuv.c	2017-02-22 10:10:19.069526211 -0500
@@ -143,6 +143,12 @@
   image=AcquireImage(image_info);
   if ((image->columns == 0) || (image->rows == 0))
     ThrowReaderException(OptionError,"MustSpecifyImageSize");
+  status=SetImageExtent(image,image->columns,image->rows);
+  if (status == MagickFalse)
+    {
+      InheritException(exception,&image->exception);
+      return(DestroyImageList(image));
+    }
   quantum=image->depth <= 8 ? 1 : 2;
   interlace=image_info->interlace;
   horizontal_factor=2;
@@ -209,6 +215,12 @@
     if ((image_info->ping != MagickFalse) && (image_info->number_scenes != 0))
       if (image->scene >= (image_info->scene+image_info->number_scenes-1))
         break;
+    status=SetImageExtent(image,image->columns,image->rows);
+    if (status == MagickFalse)
+      {
+        InheritException(exception,&image->exception);
+        return(DestroyImageList(image));
+      }
     if (interlace == PartitionInterlace)
       {
         AppendImageFormat("Y",image->filename);
